@using Microsoft.AspNet.Identity
@model VideoOnDemand.Web.Models.SerieViewModel

@{
    ViewBag.Title = "Details";
}
<style>
    .star {
        direction: rtl;
    }

        .star label:hover,
        .star label:hover ~ label {
            color: yellowgreen;
        }

    input[type="radio"]:checked ~ label {
        color: orange;
    }
</style>
<div class="container">

    <div id="general">
        <div id="imagen">
            <img src="~/images/sample.PNG" alt="" width="390" height="265" />
        </div>
        <div id="detalles">
            <h3>
                <strong>
                    @Html.DisplayFor(m => m.nombre)
                    (@Html.DisplayFor(m => m.fechaLanzamiento.Value.Year))
                </strong>
            </h3>

            <h4>
                <strong>Temporadas: </strong>
            </h4>
           
            <h4>
                <strong>Descripción: </strong>
                @Html.DisplayFor(m => m.descripcion)
            </h4>
            @{
                string gen = "";
                foreach (var g in Model.Generos)
                {
                    gen += g.Nombre + ", ";
                }
            }
            <h4>
                <strong>Género: </strong>
                @gen
            </h4>
            @{
                string act = "";
                foreach (var g in Model.Actores)
                {
                    act += g.Nombre + ", ";
                }
            }
            <h4>
                <strong>Actores: </strong>
                @act
            </h4>
            <div id="leftAll">
                <h4>
                    <button id="btnMiLista" type="button" class="btn btn-defaul">+ Mi Lista</button>
                </h4>
            </div>
        </div>
    </div>


</div>
<div class="container">
    <h3>Temporadas</h3>
    <ul class="nav nav-tabs">
        <li class="active"><a href="#home">Temporada 1</a></li>
        <li><a href="#menu1">Temporada 2</a></li>
        <li><a href="#menu2">Temporada 3</a></li>
    </ul>

    <div class="tab-content">
        <div id="home" class="tab-pane fade in active">
            <h3>Temporada 1</h3>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
        </div>
        <div id="menu1" class="tab-pane fade">
            <h3>Temporada 2</h3>
            <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        </div>
        <div id="menu2" class="tab-pane fade">
            <h3>Temporada 3</h3>
            <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam.</p>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    $(".nav-tabs a").click(function(){
        $(this).tab('show');
    });
});
</script>


<h2></h2>
<h3>@ViewBag.CountResenias Reseñas</h3>
<div class="container" style="padding-top: 18px;">
    <div class="form-group" style="border: 1px solid; ">
        <label for="txtArea" style="padding-top: 10px; padding-left: 20px;">Mi Reseña</label><label id="identityiduser" style="display:none;">@User.Identity.GetUserId()</label>
        <center>
            <textarea id="txtAreaResenia" class="form-control" style="width: 95%; height:80px; max-width: 100%; padding-left: 20px; padding-top: 10px;" placeholder="Agrega una reseña"></textarea>
        </center>
        <div class="form-horizontal">
            <form id="puntuacion" style="padding-top: 10px; padding-right: 40px; ">
                <p class="star">

                    <button id="btnAgregar" type="button" class="btn btn-defaul">Agregar</button>
                    <input id="radio1" type="radio" name="estrellas" style="display:none;" value="5">
                    <label for="radio1" style="font-size: 20px;">★</label>
                    <input id="radio2" type="radio" name="estrellas" style="display:none;" value="4">
                    <label for="radio2" style="font-size: 20px;">★</label>
                    <input id="radio3" type="radio" name="estrellas" style="display:none;" value="3">
                    <label for="radio3" style="font-size: 20px;">★</label>
                    <input id="radio4" type="radio" name="estrellas" style="display:none;" value="2">
                    <label for="radio4" style="font-size: 20px;">★</label>
                    <input id="radio5" type="radio" name="estrellas" style="display:none;" value="1">
                    <label for="radio5" style="font-size: 20px;">★</label>
                </p>
            </form>
        </div>
    </div>
</div>
<div id="lista-resenias"></div>


<br />
<br />

<div class="container">
    @Html.ActionLink("Regresar", "Index")
</div>
@section Scripts{
    <script type="text/javascript">
        $(function () {
            $("#btnAgregar").click(function () {
                guardarOpinion();
            });
            $("#btnMiLista").click(function () {
                AgregarLista();
            });

            mostrarResenias();

            $(".datepicker").datepicker({
                language: "es",
                autoclose: true
            });


        });

        function guardarOpinion() {

            var opinion = {
                Puntuacion: parseInt($('input[name=estrellas]:checked', '#puntuacion').val()),
                Descripcion: $("#txtAreaResenia").val(),
                IdentityId: $("#identityiduser").text(),
                MediaId: parseInt(@Model.id)
            };
             $.ajax({
                 url: '@Url.Action("AddResenia", "Serie")',
                 type: 'POST',
                 dataType: 'JSON',
                 contentType: "application/json",
                 data: JSON.stringify(opinion),
                 success: function (data) {
                     if (data.Success) {
                         mostrarResenias();
                         limpiar();
                         $("#txtTituloError").html("Reseña");
                         $("#txtError").html("<p>La reseña se ha publicado exitosamente</p>")
                         $("#modalError").modal("show");
                     } else {
                         if (data.TypeError == 1) {
                             $("#txtTituloError").html("Error: No se permiten más opiniones");
                             $("#txtError").html("<p>Un Usuario no puede dar mas de una reseña en una misma serie</p>")
                             $("#modalError").modal("show");
                             limpiar();
                         } else {
                             if (data.TypeError == 2) {
                                 $("#txtTituloError").html("Error: Campos Vacios");
                                 $("#txtError").html("<p>El área de la reseña no puede estar vacío</p>")
                                 $("#modalError").modal("show");
                             } else {
                                 $("#txtTituloError").html("Error: Campos Vacios");
                                 $("#txtError").html("<p>Debe calificar con un valor minimo de 1</p>")
                                 $("#modalError").modal("show");
                             }
                         }

                     }
                 }
             });
        }

        function mostrarResenias() {
            $.ajax({
                url: '@Url.Action("getResenias", "Serie", new { MediaId = Model.id })',
                type: 'GET',
                dataType: 'JSON',
                data: null,
                success: function (data) {
                    if (data.Success) {
                        //convierto la cadena a un obj JSON
                        var opiniones = JSON.parse(data.Opiniones);
                        //pinto mis elementos en mi tabla
                        $("#lista-resenias").empty();
                        for (i = 0; i < opiniones.length; i++) {
                            var o = opiniones[i];
                            var html = "<div class='container' style='padding - top: 10px;'><div class='form-group' style = 'border: 1px solid; padding-left:15px; padding-right: 15px;'>";
                            html += "<label style='padding-top: 10px;'>" + o.Usuario.Nombre + "</label>";
                            html += "<label style='padding-top: 10px; padding-left: 20px; padding-right: 20px;'>" + o.FechaRegistro + " </label>";
                            html += "<label style='padding-top: 10px; padding-left: 20px; padding-right: 20px;'>";
                            for (e = 0; e < o.Puntuacion; e++)
                            {
                                html += "<label style='font-size: 20px;'>★</label>";
                            }
                            html += "</label><p>" + o.Descripcion +"</p> </div> </div>";

                            $("#lista-resenias").append(html);
                            limpiar();
                        }
                    } else {
                    }
                }
            });
        }

        function limpiar() {
            $("#txtAreaResenia").val("");
            document.getElementById("radio1").checked = false;
            document.getElementById("radio2").checked = false;
            document.getElementById("radio3").checked = false;
            document.getElementById("radio4").checked = false;
            document.getElementById("radio5").checked = false;
        }

        function AgregarLista() {
            var favorite = {
                UserID: $("#identityiduser").text(),
                MediaId: parseInt(@Model.id)
            };
             $.ajax({
                 url: '@Url.Action("AddLista", "Serie")',
                 type: 'POST',
                 dataType: 'JSON',
                 contentType: "application/json",
                 data: JSON.stringify(favorite),
                 success: function (data) {
                     if (data.Success) {
                         $("#txtTituloError").html("Mi Lista");
                         $("#txtError").html("<p>La serie se ha agregado a su lista con éxito</p>")
                         $("#modalError").modal("show");
                     } else {
                         if (data.TypeError == 1) {
                             $("#txtTituloError").html("Error: Mi Lista");
                             $("#txtError").html("<p>Esta serie ya existe en su lista</p>")
                             $("#modalError").modal("show");
                         }
                     }
                 }
             });
        }

    </script>

}